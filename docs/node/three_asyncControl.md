# 异步写法和流程控制
<font color=#3eaf7c>流程控制</font>是程序当中的逻辑控制的统称，为什么到`Node`当中就成了<font color=#3eaf7c>异步流程控制</font>？这个和`node`本身的异步流程有关，若每个函数都是异步的，性能虽会更好，但会造成`callback hell`(回调地狱)问题，为了解决这种`API`级别的回调地狱问题，便引入了异步流程控制。

为什么说异步流程控制如此重要，因为基于`node`的事件循环执行机制和非阻塞`I/O`,异步成为常态，如果你对异步和异步写法不是很熟悉，你势必会在`node`程序当中迷失方向，可以很负责任的说这么一句话：
+ <font color=#3eaf7c>掌握了node中的异步流程控制，你就掌握了Node当中一半以上的内容</font>

异步流程控制的解决方案发展的非常迅速，从实现了<font color=#CC99CD>Thunk</font>,到<font color=#CC99CD>Promise/A+</font>规范落地，到`ES6`当中的<font color=#CC99CD>Generator</font>和<font color=#CC99CD>co</font>模块，以及到现在目前为止最被看好的<font color=#CC99CD>async</font>和<font color=#CC99CD>await</font>方案

## 异步调用
<font color=#3eaf7c>异步调用是node当中的精髓</font>，掌握了异步写法就能在编程当中游刃有余，但是想要熟悉异步调用我们必须从最基础的概念了解，首先要懂的什么是异步和同步

### 1. 异步和同步
+ <font color=#3eaf7c>同步</font>：必须等到别人的回复才能干别的事情，至死方休
+ <font color=#3eaf7c>异步</font>：充分利用时间差，合理运用时间高效做事，各不耽误

虽然这样的定义可以并不是很好懂，但是现在我们可以举个例子，比如你现在向教务处打电话要查询成绩，查完成绩要去吃饭，查成绩和吃饭实际上没有任何联系，只是你脑海里有这么个先后顺序。教务处的负责人在电话里这样说：“你先别挂电话，我马上给你查”。然后在他查询成绩的这段时间你就只能握住电话等待，但是你也不知道他啥时候查完，假如人家查了1个小时，你就必须等一个小时后再去吃饭。这就是同步，当我们和其他有交互的时候必须等待别人回复我们才能做后面的事。

由于信号不好，现在你又打电话给教务处打电话查询成绩，此时教务处的负责人在电话里这样说：“我们这边已经有你的电话了，等我们查到你成绩了给你回电话”，说完他就挂了电话，此时的你在教务处回复你的期间可以去吃饭，你可以吃饭，你还可以旅游去，也不用等待和担心，因为教务处查到成绩会自动给你回话，这就是异步，充分利用了打电话和最后知道成绩的这个期间的时间干自己的事。

`node`当中的同步和异步也是如此，如果两个操作没有直接的联系，只有书写代码先后执行的问题，那么最好用异步的方式去执行，这样不会造成后面程序的执行阻塞在同步的等待当中。

### 2. 浏览器和node的异步原理
不知道你们发现了没有，在异步调用当中，我们自己是无法独自完成异步，必须依靠某个东西和我们共同完成，就好比上个例子当中的教务处负责人，他负责接收我的查成绩的请求，并在查到成绩后主动给我电话或发短信通知我。至于他是自己用电脑去学校系统上查还是叫下属拿出成绩册看，我们并不关心实际交互的过程。所以这个教务处的负责人是整个异步的核心。

<font color=#3eaf7c>所以不管什么异步模式当中是一定有这样一个核心中间人，去做最重要的三件事：</font><font color=#CC99CD>接收异步请求</font>、<font color=#CC99CD>发生异步交互</font>、<font color=#CC99CD>返回异步响应</font>

**1. 浏览器中的异步**

我们知道在浏览器当中异步模式是依赖于<font color=#3eaf7c>Ajax</font>的，而`Ajax`中的核心，或者核心中间人就是<font color=#CC99CD>XMLHttpRequest</font>，如下图：

<img :src="$withBase('/async_ajax_brower.png')" alt="浏览器中的异步">

如上图,`Ajax`定义好请求和回调函数后，剩下的事情就交给`XMLHttpRequest`处理，`XMLHttpRequest`会和服务器交互，并产生时间差役，所以异步操作能够很好的解决这个问题，不需要刷新页面就能获取数据。

**2. node中的异步**

我们知道在`Node`当中异步模式是依赖于<font color=#3eaf7c>异步非阻塞I/O模型</font>的，而这种模型中的核心，或者核心中间人就是<font color=#CC99CD>EventLoop</font>，如下图：

<img :src="$withBase('/async_node_js.png')" alt="node中的异步">

如上图，我们在调用`Node API`方法的时候，会把具体操作和回调函数交给`EventLoop`去执行，`EventLoop`维护了一个事件队列，当异步函数执行的时候，会把回调函数放进事件队列当中，`V8`引擎知道异步函数执行完成才会开始处理`EventLoop`,这意味着`JavaScript`代码不是多线程的，及时好像看起来能同时执行多个线程的任务

**3. 总结**

无论是`Ajax`还是`Node`,都是借助<font color=#3eaf7c>中间层</font>来进行实际操作的，在使用的时候无须过多关注中间层之后的操作就能完成功能开发，这就是`Node`的特点，能够以最小的成本获取高性能，只需要专注写代码即可。

## node自带的异步写法

## 更好的异步流程